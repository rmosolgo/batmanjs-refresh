<!DOCTYPE html>

<html>
<head>
  <title>refresh.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>refresh.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Out of the box, HTMLStore’s default accessor is <em>final</em>,
meaning it can’t change after the first <code>set</code>.
Let’s undo that:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>storeAccessor = Batman.<span class="hljs-attribute">HTMLStore</span>::_batman.getFirst(<span class="hljs-string">'defaultAccessor'</span>)
storeAccessor.final = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>And define an unset operation:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>storeAccessor.<span class="hljs-function"><span class="hljs-title">unset</span> = <span class="hljs-params">(path)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> !path.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">"/"</span>
    path = <span class="hljs-string">"/<span class="hljs-subst">#{path}</span>"</span>
  <span class="hljs-property">@_requestedPaths</span>.remove(path)
  <span class="hljs-property">@_htmlContents</span>[path] = <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Climbs the view tree, looking for one that has a source</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Batman.<span class="hljs-attribute">View</span>::<span class="hljs-function"><span class="hljs-title">superviewWithSource</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@get</span>(<span class="hljs-string">'source'</span>)?
    <span class="hljs-keyword">return</span> @
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@superview</span>.superviewWithSource()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Climbs the view try to find a souce, then refreshes it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Batman.<span class="hljs-attribute">View</span>::<span class="hljs-function"><span class="hljs-title">refreshHTML</span> = -&gt;</span>
  <span class="hljs-property">@sourceView</span> ?= <span class="hljs-property">@superviewWithSource</span>()
  sourceView = <span class="hljs-property">@sourceView</span>
  sourceView.html = <span class="hljs-literal">undefined</span>
  path = sourceView.get(<span class="hljs-string">'source'</span>)
  <span class="hljs-keyword">if</span> path.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-string">"/"</span>
    path = <span class="hljs-string">"/<span class="hljs-subst">#{path}</span>"</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"refreshing <span class="hljs-subst">#{path}</span>"</span>
  Batman.View.store.unset(path)
  sourceView._HTMLObserver ?= Batman.View.store.observe path, <span class="hljs-function"><span class="hljs-params">(nv, ov)</span> =&gt;</span>
    sourceView.set(<span class="hljs-string">'html'</span>, nv)
    sourceView.loadView()
    sourceView.initializeBindings()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Tries to refresh all children of the layout view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Batman.<span class="hljs-function"><span class="hljs-title">refreshHTML</span> = -&gt;</span>
  Batman.currentApp
    .get(<span class="hljs-string">'layout.subviews'</span>)
    .filter<span class="hljs-function"><span class="hljs-params">((sv) -&gt; sv.get(<span class="hljs-string">'source'</span>)?)</span>
    .<span class="hljs-title">forEach</span><span class="hljs-params">((sv) -&gt; sv.refreshHTML())</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Reload stylesheets
from stackoverflow.com/questions/2024486/is-there-an-easy-way-to-reload-css-without-reloading-the-page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Batman.<span class="hljs-function"><span class="hljs-title">refreshCSS</span> = -&gt;</span>
  queryString = <span class="hljs-string">'?reload='</span> + <span class="hljs-keyword">new</span> Date().getTime();
  refreshed = []
  $(<span class="hljs-string">'link[rel="stylesheet"]'</span>).each<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span>.href.indexOf(<span class="hljs-built_in">window</span>.location.host) &gt; -<span class="hljs-number">1</span>
      refreshed.push(<span class="hljs-keyword">this</span>.href)
      <span class="hljs-keyword">this</span>.href = <span class="hljs-keyword">this</span>.href.replace(<span class="hljs-regexp">/\?.*|$/</span>, queryString)
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"refreshed \n<span class="hljs-subst">#{refreshed.join(<span class="hljs-string">"\n"</span>)}</span>"</span>
  <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Reload the children of the layout and reload stylesheets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Batman.<span class="hljs-function"><span class="hljs-title">refreshAll</span> = -&gt;</span>
  Batman.refreshHTML()
  Batman.refreshCSS()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
